name: CI-CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  node-lint:
    name: Lint Node.js
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci
      - name: Lint sources
        run: npm run lint

  python-check:
    name: Verificar integração HA
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Instalar dependências mínimas
        run: |
          python -m pip install --upgrade pip
          python -m pip install aiohttp
      - name: Validar sintaxe
        run: python -m compileall custom_components/prudentes_tuya_all
      - name: Teste opcional de descoberta Tuya
        env:
          TUYA_ACCESS_ID: ${{ secrets.TUYA_ACCESS_ID }}
          TUYA_ACCESS_SECRET: ${{ secrets.TUYA_ACCESS_SECRET }}
          TUYA_REGION: ${{ secrets.TUYA_REGION }}
          TUYA_BASE_URL: ${{ secrets.TUYA_BASE_URL }}
        run: python scripts/ci_tuya_discovery.py

  docker-smoke:
    name: Build Docker images
    runs-on: ubuntu-latest
    needs: [node-lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build app image
        run: docker build -t codex-app:ci .
      - name: Build demo publisher
        run: docker build -t codex-demo:ci -f Dockerfile.demo .
